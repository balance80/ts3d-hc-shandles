var shandle;(()=>{"use strict";var t={d:(e,i)=>{for(var o in i)t.o(i,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:i[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{AxisHandleGroup:()=>_,StandardHandleManager:()=>m,StandardHandleOperator:()=>p});class i{constructor(t){this._group=t,this._nodeid=null}getType(){return this._type}async show(){let t=this._group.getViewer();this._nodeid&&(t.overlayManager.addNodes(m.overlayIndex,[this._nodeid]),t.model.setInstanceModifier(Communicator.InstanceModifier.SuppressCameraScale,[this._nodeid],!0),t.model.setInstanceModifier(Communicator.InstanceModifier.DoNotLight,[this._nodeid],!0))}update(){}cameraUpdate(t){}}function o(t,e,i){let o=[],n=[],r=new Communicator.MeshData,a=null;for(let r=0;r<t.length;r++){let s,h=[];if(s=r<t.length-1?Communicator.Point3.subtract(t[r+1],t[r]).normalize():Communicator.Point3.subtract(t[r],t[r-1]).normalize(),Communicator.Util.generatePointsOnCircle(h,t[r],e,i,s),r>0){let t=h[0],e=1e11,r=0;for(let i=0;i<a.length;i++)Communicator.Point3.distance(t,a[i])<e&&(e=Communicator.Point3.distance(t,a[i]),r=i);let s,l=r;s=l==a.length-1?0:l+1;let m=0;for(let t=0;t<i;t++){let e=m+r,s=m+r+1;e>a.length-1&&(e=e-a.length+1),s>a.length-1&&(s=s-a.length+1),m++,e<0&&(e=a.length-1+e),s<0&&(s=a.length-1+s);let l=t+1;l>i-1&&(l=0),o.push(a[e].x,a[e].y,a[e].z),o.push(h[t].x,h[t].y,h[t].z),o.push(h[l].x,h[l].y,h[l].z),o.push(h[l].x,h[l].y,h[l].z),o.push(a[s].x,a[s].y,a[s].z),o.push(a[e].x,a[e].y,a[e].z);let d=Communicator.Plane.createFromPoints(a[e],h[t],h[l]);for(let t=0;t<6;t++)n.push(d.normal.x,d.normal.y,d.normal.z)}}a=h}return r.addFaces(o,n),r}function n(t,e,i){let o=function(t){let e=new Communicator.Matrix;return e.setTranslationComponent(t.x,t.y,t.z),e}(t),n=Communicator.Matrix.multiply(e,Communicator.Matrix.inverse(o)),r=Communicator.Matrix.multiply(n,i);return Communicator.Matrix.multiply(r,o)}function r(t,e){let i=t.transform(new Communicator.Point3(0,0,0)),o=t.transform(e),n=Communicator.Point3.subtract(o,i);return n.normalize(),n}function a(t,e){let i=t.view.getCamera(),o=i.getPosition(),n=i.getTarget(),r=Communicator.Point3.subtract(n,o).normalize();return Communicator.Plane.createFromPointAndNormal(e,r)}function s(t,e,i,o){return h(Communicator.Point3.subtract(t,o),Communicator.Point3.subtract(e,o),i)}function h(t,e,i){return Math.atan2(Communicator.Point3.dot(Communicator.Point3.cross(t,e),i),Communicator.Point3.dot(t,e))*(180/Math.PI)}function l(t,e){let i=Communicator.Point3.dot(t.normal,e)+t.d;return Communicator.Point3.subtract(e,new Communicator.Point3(i*t.normal.x,i*t.normal.y,i*t.normal.z))}class m{constructor(t){this._viewer=t,this._handles=[],this._handlenode=this._viewer.model.createNode(this._viewer.model.getRootNode(),"advancedHandles");var e=this;this._viewer.overlayManager.setCamera(m.overlayIndex,this._viewer.view.getCamera()),this._viewer.setCallbacks({camera:function(t,i,o,n){e._viewer.overlayManager.setCamera(m.overlayIndex,e._viewer.view.getCamera());for(let t=0;t<e._handles.length;t++)e._handles[t].cameraUpdate(e._viewer.view.getCamera())}}),this._viewer.overlayManager.setViewport(m.overlayIndex,Communicator.OverlayAnchor.UpperLeftCorner,0,Communicator.OverlayUnit.ProportionOfCanvas,0,Communicator.OverlayUnit.ProportionOfCanvas,1,Communicator.OverlayUnit.ProportionOfCanvas,1,Communicator.OverlayUnit.ProportionOfCanvas),this._defineBaseGeometry()}async _defineBaseGeometry(){let t=[];Communicator.Util.generatePointsOnCircle(t,new Communicator.Point3(0,0,0),.15,64,new Communicator.Point3(0,0,1));let e=o(t.splice(0,t.length/2),.0045,10);this._arcmesh=await this._viewer.model.createMesh(e),this._sphereMesh=await async function(t){const e=(1+Math.sqrt(5))/2,i=Math.sqrt(10+2*Math.sqrt(5))/(4*e),o=i/2,n=i/(2*e),r=[];r[0]=new Communicator.Point3(-n,o,0),r[1]=new Communicator.Point3(n,o,0),r[2]=new Communicator.Point3(-n,-o,0),r[3]=new Communicator.Point3(n,-o,0),r[4]=new Communicator.Point3(0,-n,o),r[5]=new Communicator.Point3(0,n,o),r[6]=new Communicator.Point3(0,-n,-o),r[7]=new Communicator.Point3(0,n,-o),r[8]=new Communicator.Point3(o,0,-n),r[9]=new Communicator.Point3(o,0,n),r[10]=new Communicator.Point3(-o,0,-n),r[11]=new Communicator.Point3(-o,0,n);for(let t=0;t<r.length;t++)r[t].normalize();let a=[[0,11,5],[0,5,1],[0,1,7],[0,7,10],[0,10,11],[1,5,9],[5,11,4],[11,10,2],[10,7,6],[7,1,8],[3,9,4],[3,4,2],[3,2,6],[3,6,8],[3,8,9],[4,9,5],[2,4,11],[6,2,10],[8,6,7],[9,8,1]],s=12;for(let t=0;t<3;t++){let t=[];a.map((e=>{const i=r[e[0]],o=r[e[1]],n=r[e[2]];r[s++]=new Communicator.Point3(i.x+o.x,i.y+o.y,i.z+o.z).scale(.5).normalize(),r[s++]=new Communicator.Point3(o.x+n.x,o.y+n.y,o.z+n.z).scale(.5).normalize(),r[s++]=new Communicator.Point3(n.x+i.x,n.y+i.y,n.z+i.z).scale(.5).normalize(),t.push([e[0],s-3,s-1]),t.push([s-3,s-2,s-1]),t.push([s-3,e[1],s-2]),t.push([s-2,e[2],s-1])})),a=t}const h=[],l=[];for(const t of a)for(let e=0;e<3;e++){const i=t[e];h.push(r[i].x),h.push(r[i].y),h.push(r[i].z);const o=r[i].normalize();l.push(o.x),l.push(o.y),l.push(o.z)}const m=new Communicator.MeshData;return m.addFaces(h,l),m.setFaceWinding(Communicator.FaceWinding.CounterClockwise),await t.model.createMesh(m)}(this._viewer);let i=[];Communicator.Util.generatePointsOnCircle(i,new Communicator.Point3(0,0,0),.15,64,new Communicator.Point3(0,0,1));let n=o(i,.0045,10);this._circleMesh=await this._viewer.model.createMesh(n)}async create(t,e=null,o=null){let n=new i(this._viewer,this);await n.show(t,e,o),this._handles.push(n)}async add(t,e,i=null,o=null){this._handles.push(t),await t.show(e,i,o)}remove(){this._viewer.model.deleteNode(this._handlenode),this._handlenode=this._viewer.model.createNode(this._viewer.model.getRootNode(),"advancedHandles"),this._handles=[]}getHandleGroup(t){for(let e=0;e<this._handles.length;e++)if(this._handles[e]._topNode==t||this._handles[e]._topNode2==t)return this._handles[e]}refreshAll(t){for(let e=0;e<this._handles.length;e++)this._handles[e]!=t&&(this._handles[e]._targetCenter=this._viewer.model.getNodeNetMatrix(this._handles[e]._targetNodes[0]).transform(this._handles[e]._targetCenterLocal),this._handles[e].updateHandle())}}m.overlayIndex=7;class d{constructor(t,e){this._viewer=t,this._manager=e,this._handles=[],this._targetNodes=null,this._relative=!0}getManager(){return this._manager}getViewer(){return this._viewer}remove(){this._viewer.model.deleteNode(this._handlenode)}setRelative(t){this._relative=t,this.updateHandle()}getRelative(){return this._relative}cameraUpdate(t){for(let e=0;e<this._handles.length;e++)this._handles[e].cameraUpdate(t)}getHandle(t){for(let e=0;e<this._handles.length;e++)if(this._handles[e]._nodeid==t)return this._handles[e]}updateHandle(){let t=this._calculateStartMatrix(),e=this._targetCenter,i=new Communicator.Matrix;i.setTranslationComponent(e.x,e.y,e.z);let o=Communicator.Matrix.multiply(t,i);this._viewer.model.setNodeMatrix(this._topNode,o),hwv.model.setNodeMatrix(this._topNode2,i);for(let t=0;t<this._handles.length;t++)this._handles[t].update(this._viewer.view.getCamera())}async show(t,e=null,i=null){if(this._targetNodes=t,e)this._targetCenter=e.copy();else{let e=await this._viewer.model.getNodesBounding(t);this._targetCenter=e.center()}this._targetCenterLocal=Communicator.Matrix.inverse(this._viewer.model.getNodeNetMatrix(this._targetNodes[0])).transform(this._targetCenter),this._extraRotation=i,this._topNode=this._viewer.model.createNode(this._manager._handlenode,""),this._topNode2=this._viewer.model.createNode(this._manager._handlenode,"");let o=this._calculateStartMatrix(),n=new Communicator.Matrix;n.setTranslationComponent(this._targetCenter.x,this._targetCenter.y,this._targetCenter.z);let r=Communicator.Matrix.multiply(o,n);this._viewer.model.setNodeMatrix(this._topNode,r),this._viewer.model.setNodeMatrix(this._topNode2,n)}_calculateStartMatrix(){let t=new Communicator.Matrix;if(this._relative){let e=this._viewer.model.getNodeNetMatrix(this._targetNodes[0]).copy(),i=new Communicator.Point3(e.m[0],e.m[1],e.m[2]).normalize(),o=new Communicator.Point3(e.m[4],e.m[5],e.m[6]).normalize(),n=new Communicator.Point3(e.m[8],e.m[9],e.m[10]).normalize();t.m[0]=i.x,t.m[1]=i.y,t.m[2]=i.z,t.m[4]=o.x,t.m[5]=o.y,t.m[6]=o.z,t.m[8]=n.x,t.m[9]=n.y,t.m[10]=n.z}return this._extraRotation&&(t=Communicator.Matrix.multiply(this._extraRotation,t)),t}}class c extends i{constructor(t,e,i,o){super(t),this._type=0,this._axis=e,this._rotation=i,this._color=o}async show(){let t=this._group.getViewer(),e=new Communicator.Matrix;this._axis&&Communicator.Util.computeOffaxisRotation(this._axis,this._rotation,e),this._nodeid=t.model.createNode(this._group._topNode,"");let i=new Communicator.MeshInstanceData(this._group.getManager()._arcmesh);await t.model.createMeshInstance(i,this._nodeid),this._axis&&t.model.setNodeMatrix(this._nodeid,e),t.model.setNodesFaceColor([this._nodeid],this._color),await super.show(),await this.orientToCamera(t.view.getCamera())}cameraUpdate(t){this.orientToCamera(t)}update(t){this.orientToCamera(t)}async orientToCamera(t){let e=this._group.getViewer(),i=t.getPosition(),o=e.model.getNodeMatrix(this._nodeid),n=e.model.getNodeNetMatrix(this._nodeid),r=Communicator.Matrix.inverse(n).transform(i),a=l(Communicator.Plane.createFromPointAndNormal(new Communicator.Point3(0,0,0),new Communicator.Point3(0,0,1)),r);a.normalize();let s=h(new Communicator.Point3(-1,0,0),a,new Communicator.Point3(0,0,1)),m=new Communicator.Matrix;Communicator.Util.computeOffaxisRotation(new Communicator.Point3(0,0,1),s,m);let d=Communicator.Matrix.multiply(m,o);await e.model.setNodeMatrix(this._nodeid,d)}}class u extends i{constructor(t,e,i){super(t),this._type=2,this._color=e,this._opacity=i}async show(){let t=this._group.getViewer();this._nodeid=t.model.createNode(this._group._topNode,"");let e=new Communicator.MeshInstanceData(this._group.getManager()._sphereMesh);await t.model.createMeshInstance(e,this._nodeid);let i=new Communicator.Matrix;i.setScaleComponent(.15,.15,.15),t.model.setNodeMatrix(this._nodeid,i),t.model.setNodesFaceColor([this._nodeid],this._color),t.model.setNodesOpacity([this._nodeid],this._opacity),await super.show()}}class w extends i{constructor(t,e){super(t),this._type=1,this._color=e}async show(){let t=this._group.getViewer();this._nodeid=t.model.createNode(this._group._topNode2,"");let e=new Communicator.MeshInstanceData(this._group.getManager()._circleMesh);await t.model.createMeshInstance(e,this._nodeid);let i=new Communicator.Matrix;i.setScaleComponent(1.2,1.2,1.2),t.model.setNodeMatrix(this._nodeid,i),t.model.setNodesFaceColor([this._nodeid],this._color),await super.show(),t.model.setInstanceModifier(Communicator.InstanceModifier.ScreenOriented,[this._nodeid],!0)}}class _ extends d{constructor(t,e){super(t,e)}async show(t,e=null,i=null){await super.show(t,e,i),this._handles.push(new c(this,null,0,new Communicator.Color(255,0,0))),this._handles.push(new c(this,new Communicator.Point3(0,1,0),90,new Communicator.Color(0,255,0))),this._handles.push(new c(this,new Communicator.Point3(1,0,0),90,new Communicator.Color(0,0,255))),this._handles.push(new u(this,new Communicator.Color(0,255,0),.3)),this._handles.push(new w(this,new Communicator.Color(222,222,222)));for(let t=0;t<this._handles.length;t++)await this._handles[t].show()}}var g;!function(t){function e(t,e){var i=Math.abs(t),o=Math.abs(e);return 0===t?Math.log(o):0===e?Math.log(i):3e3>i&&3e3>o?.5*Math.log(t*t+e*e):Math.log(t/Math.cos(Math.atan2(e,t)))}function i(t,e,i,o,n){if(void 0!==n)t.w=e,t.x=i,t.y=o,t.z=n;else{if("object"==typeof e&&void 0===o){if("w"in e||"x"in e||"y"in e||"z"in e)return t.w=e.w||0,t.x=e.x||0,t.y=e.y||0,void(t.z=e.z||0);if("re"in e&&"im"in e)return t.w=e.re,t.x=e.im,t.y=0,void(t.z=0);if(4===e.length)return t.w=e[0],t.x=e[1],t.y=e[2],void(t.z=e[3]);if(3===e.length)return t.w=0,t.x=e[0],t.y=e[1],void(t.z=e[2]);throw Error("Invalid object")}if("string"==typeof e&&void 0===o){var a=1;if(i=0,o={i:"x",j:"y",k:"z"},null===(e=e.match(/\d+\.?\d*e[+-]?\d+|\d+\.?\d*|\.\d+|./g)))throw Error("Parse error");for(n=t.w=t.x=t.y=t.z=0;n<e.length;n++){var s=e[n],h=e[n+1];if(" "!==s&&"\t"!==s&&"\n"!==s)if("+"===s)a++;else if("-"===s)i++;else{if(0===a+i)throw Error("Parse error"+s);if(void 0!==(a=o[s]))" "===h||isNaN(h)?s="1":(s=h,n++);else{if(isNaN(s))throw Error("Parser error");void 0!==(a=o[h])&&n++}t[a||"w"]+=parseFloat((i%2?"-":"")+s),a=i=0}}if(0<a+i)throw Error("Parser error")}else void 0===e&&t!==r?(t.w=1,t.x=t.y=t.z=0):(t.w=e||0,i&&3===i.length?(t.x=i[0],t.y=i[1],t.z=i[2]):(t.x=i||0,t.y=o||0,t.z=n||0))}}function o(t,e,i){var o="";return 0!==t&&(""!==i?o+=0>t?" - ":" + ":0>t&&(o+="-"),1===(t=Math.abs(t))&&""!==e||(o+=t),o+=e),o}function n(t,e,o,r){if(!(this instanceof n))return new n(t,e,o,r);i(this,t,e,o,r)}var r={w:1,x:0,y:0,z:0};n.prototype={w:1,x:0,y:0,z:0,add:function(t,e,o,a){return i(r,t,e,o,a),new n(this.w+r.w,this.x+r.x,this.y+r.y,this.z+r.z)},sub:function(t,e,o,a){return i(r,t,e,o,a),new n(this.w-r.w,this.x-r.x,this.y-r.y,this.z-r.z)},neg:function(){return new n(-this.w,-this.x,-this.y,-this.z)},norm:function(){var t=this.w,e=this.x,i=this.y,o=this.z;return Math.sqrt(t*t+e*e+i*i+o*o)},normSq:function(){var t=this.w,e=this.x,i=this.y,o=this.z;return t*t+e*e+i*i+o*o},normalize:function(){var t=this.w,e=this.x,i=this.y,o=this.z,r=Math.sqrt(t*t+e*e+i*i+o*o);return r<n.EPSILON?n.ZERO:new n(t*(r=1/r),e*r,i*r,o*r)},mul:function(t,e,o,a){i(r,t,e,o,a),t=this.w,e=this.x,o=this.y,a=this.z;var s=r.w,h=r.x,l=r.y,m=r.z;return new n(t*s-e*h-o*l-a*m,t*h+e*s+o*m-a*l,t*l+o*s+a*h-e*m,t*m+a*s+e*l-o*h)},scale:function(t){return new n(this.w*t,this.x*t,this.y*t,this.z*t)},dot:function(t,e,o,n){return i(r,t,e,o,n),this.w*r.w+this.x*r.x+this.y*r.y+this.z*r.z},inverse:function(){var t=this.w,e=this.x,i=this.y,o=this.z,r=t*t+e*e+i*i+o*o;return 0===r?n.ZERO:new n(t*(r=1/r),-e*r,-i*r,-o*r)},div:function(t,e,o,a){i(r,t,e,o,a),t=this.w,e=this.x,o=this.y,a=this.z;var s=r.w,h=r.x,l=r.y,m=r.z,d=s*s+h*h+l*l+m*m;return 0===d?n.ZERO:new n((t*s+e*h+o*l+a*m)*(d=1/d),(e*s-t*h-o*m+a*l)*d,(o*s-t*l-a*h+e*m)*d,(a*s-t*m-e*l+o*h)*d)},conjugate:function(){return new n(this.w,-this.x,-this.y,-this.z)},exp:function(){var t=this.x,e=this.y,i=this.z,o=Math.sqrt(t*t+e*e+i*i),r=Math.exp(this.w),a=r/o*Math.sin(o);return 0===o?new n(r,0,0,0):new n(r*Math.cos(o),t*a,e*a,i*a)},log:function(){var t=this.w,i=this.x,o=this.y,r=this.z;if(0===o&&0===r)return new n(e(t,i),Math.atan2(i,t),0,0);var a=Math.sqrt(i*i+o*o+r*r);return a=Math.atan2(a,t)/a,new n(.5*Math.log(i*i+o*o+r*r+t*t),i*a,o*a,r*a)},pow:function(t,o,a,s){if(i(r,t,o,a,s),0===r.y&&0===r.z){if(1===r.w&&0===r.x)return this;if(0===r.w&&0===r.x)return n.ONE;if(0===this.y&&0===this.z){if(t=this.w,o=this.x,0===t&&0===o)return n.ZERO;if(a=Math.atan2(o,t),s=e(t,o),0===r.x){if(0===o&&0<=t)return new n(Math.pow(t,r.w),0,0,0);if(0===t)switch(r.w%4){case 0:return new n(Math.pow(o,r.w),0,0,0);case 1:return new n(0,Math.pow(o,r.w),0,0);case 2:return new n(-Math.pow(o,r.w),0,0,0);case 3:return new n(0,-Math.pow(o,r.w),0,0)}}return t=Math.exp(r.w*s-r.x*a),o=r.x*s+r.w*a,new n(t*Math.cos(o),t*Math.sin(o),0,0)}}return this.log().a(r).exp()},equals:function(t,e,o,a){return i(r,t,e,o,a),t=n.EPSILON,Math.abs(r.w-this.w)<t&&Math.abs(r.x-this.x)<t&&Math.abs(r.y-this.y)<t&&Math.abs(r.z-this.z)<t},isFinite:function(){return isFinite(this.w)&&isFinite(this.x)&&isFinite(this.y)&&isFinite(this.z)},isNaN:function(){return isNaN(this.w)||isNaN(this.x)||isNaN(this.y)||isNaN(this.z)},toString:function(){var t=this.w,e=this.x,i=this.y,n=this.z;return isNaN(t)||isNaN(e)||isNaN(i)||isNaN(n)?"NaN":(t=o(t,"",""),t+=o(e,"i",t),t+=o(i,"j",t),""===(t+=o(n,"k",t))?"0":t)},real:function(){return this.w},imag:function(){return[this.x,this.y,this.z]},toVector:function(){return[this.w,this.x,this.y,this.z]},toMatrix:function(t){var e=this.w,i=this.x,o=this.y,n=this.z,r=e*e+i*i+o*o+n*n,a=0===r?0:2/r;r=a*e*i;var s=a*e*o;e=a*e*n;var h=a*i*i,l=a*i*o;i=a*i*n;var m=a*o*o;return o=a*o*n,n*=a*n,t?[[1-(m+n),l-e,i+s],[l+e,1-(h+n),o-r],[i-s,o+r,1-(h+m)]]:[1-(m+n),l-e,i+s,l+e,1-(h+n),o-r,i-s,o+r,1-(h+m)]},toMatrix4:function(t){var e=this.w,i=this.x,o=this.y,n=this.z,r=e*e+i*i+o*o+n*n,a=0===r?0:2/r;r=a*e*i;var s=a*e*o;e=a*e*n;var h=a*i*i,l=a*i*o;i=a*i*n;var m=a*o*o;return o=a*o*n,n*=a*n,t?[[1-(m+n),l-e,i+s,0],[l+e,1-(h+n),o-r,0],[i-s,o+r,1-(h+m),0],[0,0,0,1]]:[1-(m+n),l-e,i+s,0,l+e,1-(h+n),o-r,0,i-s,o+r,1-(h+m),0,0,0,0,1]},clone:function(){return new n(this)},rotateVector:function(t){var e=this.w,i=this.x,o=this.y,n=this.z,r=t[0],a=t[1],s=t[2],h=e*r+o*s-n*a,l=e*a+n*r-i*s;return[h*e-(t=-i*r-o*a-n*s)*i-l*n+(r=e*s+i*a-o*r)*o,l*e-t*o-r*i+h*n,r*e-t*n-h*o+l*i]},slerp:function(t,e,o,a){i(r,t,e,o,a);var s=this.w,h=this.x,l=this.y,m=this.z,d=r.w,c=r.x,u=r.y,w=r.z,_=s*d+h*c+l*u+m*w;if(0>_&&(s=-s,h=-h,l=-l,m=-m,_=-_),.9995<_)return function(t){return new n(s+t*(d-s),h+t*(c-h),l+t*(u-l),m+t*(w-m)).normalize()};var g=Math.acos(_),C=Math.sin(g);return function(t){var e=g*t;return t=Math.sin(e),new n((e=Math.cos(e)-_*t/C)*s+(t/=C)*d,e*h+t*c,e*l+t*u,e*m+t*w)}}},n.ZERO=new n(0,0,0,0),n.ONE=new n(1,0,0,0),n.I=new n(0,1,0,0),n.J=new n(0,0,1,0),n.K=new n(0,0,0,1),n.EPSILON=1e-16,n.fromAxisAngle=function(t,e){var i=.5*e,o=t[0],r=t[1],a=t[2],s=Math.sin(i)/Math.sqrt(o*o+r*r+a*a);return new n(Math.cos(i),o*s,r*s,a*s)},n.fromBetweenVectors=function(t,e){var i=t[0],o=t[1],r=t[2],a=e[0],s=e[1],h=e[2],l=i*a+o*s+r*h,m=o*h-r*s;return r=r*a-i*h,i=i*s-o*a,new n(l+Math.sqrt(l*l+m*m+r*r+i*i),m,r,i).normalize()},n.fromEuler=function(t,e,i,o){var r=.5*e,a=.5*i,s=.5*t;return t=Math.cos(r),i=Math.cos(a),e=Math.cos(s),r=Math.sin(r),a=Math.sin(a),s=Math.sin(s),void 0===o||"ZXY"===o?new n(t*i*e-r*a*s,r*i*e-t*a*s,t*a*e+r*i*s,t*i*s+r*a*e):"XYZ"===o?new n(t*i*e-r*a*s,r*i*e+t*a*s,t*a*e-r*i*s,t*i*s+r*a*e):"YXZ"===o?new n(t*i*e+r*a*s,r*i*e+t*a*s,t*a*e-r*i*s,t*i*s-r*a*e):"ZYX"===o?new n(t*i*e+r*a*s,r*i*e-t*a*s,t*a*e+r*i*s,t*i*s-r*a*e):"YZX"===o?new n(t*i*e-r*a*s,r*i*e+t*a*s,t*a*e+r*i*s,t*i*s-r*a*e):"XZY"===o?new n(t*i*e+r*a*s,r*i*e-t*a*s,t*a*e-r*i*s,t*i*s+r*a*e):null},g=n}();const C=g;class p{constructor(t,e){this._viewer=t,this._manager=e,this._startmatrix=null,this._selectedHandleGroup=null,this._isClick=!1}async onMouseDown(t){this._selectedHandleGroup=null,this._isClick=!0;let e=new Communicator.PickConfig(Communicator.SelectionMask.Line);e.restrictToOverlays=!0;const i=await this._viewer.view.pickFromPoint(t.getPosition(),e);if(i.getPosition()){let e=this._viewer.model.getNodeParent(i.getNodeId()),o=this._viewer.model.getNodeParent(e),n=this._manager.getHandleGroup(o);if(n){this._selectedHandleGroup=n,this._selectedHandle=n.getHandle(e),this._startmatrix=await this._viewer.model.getNodeNetMatrix(this._selectedHandle._nodeid),this._startTargetMatrices=[];for(let t=0;t<this._selectedHandleGroup._targetNodes.length;t++)this._startTargetMatrices.push(this._viewer.model.getNodeMatrix(this._selectedHandleGroup._targetNodes[t]));this._startPosition=i.getPosition(),this._startPosition2D=t.getPosition(),t.setHandled(!0),this._doQuaternion=!1,this._viewplaneRotate=!1,this.oldColor=await this._viewer.model.getNodesFaceColor([e]),this._viewer.model.setNodesFaceColor([e],new Communicator.Color(255,255,0))}}}async onMouseMove(t){if(this._isClick=!1,this._selectedHandleGroup){if(1==this._selectedHandle.getType()){let e=a(this._viewer,this._startPosition),i=this._viewer.view.raycastFromPoint(t.getPosition()),o=new Communicator.Point3;e.intersectsRay(i,o);let h=this._viewer.view.raycastFromPoint(this._startPosition2D),l=new Communicator.Point3;e.intersectsRay(h,l);let m=s(l,o,e.normal,this._selectedHandleGroup._targetCenter);for(let t=0;t<this._startTargetMatrices.length;t++){let i=r(Communicator.Matrix.inverse(this._viewer.model.getNodeNetMatrix(hwv.model.getNodeParent(this._selectedHandleGroup._targetNodes[t]))),e.normal),o=new Communicator.Matrix;Communicator.Util.computeOffaxisRotation(i,m,o);let a=Communicator.Matrix.inverse(this._viewer.model.getNodeNetMatrix(hwv.model.getNodeParent(this._selectedHandleGroup._targetNodes[t]))).transform(this._selectedHandleGroup._targetCenter);this._viewer.model.setNodeMatrix(this._selectedHandleGroup._targetNodes[t],n(a,this._startTargetMatrices[t],o))}this._selectedHandleGroup.updateHandle()}else if(2==this._selectedHandle.getType()){let e=new Communicator.PickConfig(Communicator.SelectionMask.Line);e.restrictToOverlays=!0;const i=await this._viewer.view.pickFromPoint(t.getPosition(),e);if(i.getPosition()){let t=i.getPosition(),e=Communicator.Point3.subtract(this._startPosition,this._selectedHandleGroup._targetCenter);e.normalize();let o=Communicator.Point3.subtract(t,this._selectedHandleGroup._targetCenter);o.normalize();for(let t=0;t<this._startTargetMatrices.length;t++){let i=r(Communicator.Matrix.inverse(this._viewer.model.getNodeNetMatrix(hwv.model.getNodeParent(this._selectedHandleGroup._targetNodes[t]))),e),a=r(Communicator.Matrix.inverse(this._viewer.model.getNodeNetMatrix(hwv.model.getNodeParent(this._selectedHandleGroup._targetNodes[t]))),o),s=C.fromBetweenVectors([i.x,i.y,i.z],[a.x,a.y,a.z]),h=new Communicator.Quaternion(s.x,s.y,s.z,s.w),l=Communicator.Quaternion.toMatrix(h),m=Communicator.Matrix.inverse(this._viewer.model.getNodeNetMatrix(hwv.model.getNodeParent(this._selectedHandleGroup._targetNodes[t]))).transform(this._selectedHandleGroup._targetCenter);this._viewer.model.setNodeMatrix(this._selectedHandleGroup._targetNodes[t],n(m,this._startTargetMatrices[t],l))}this._selectedHandleGroup.updateHandle()}}else{let e=new Communicator.Point3(0,0,0),i=new Communicator.Point3(0,0,1);!function(t,e,i){let o=r(t,i);i.set(o.x,o.y,o.z);let n=t.transform(e);e.set(n.x,n.y,n.z)}(this._startmatrix,e,i);let o=a(this._viewer,this._startPosition),h=this._viewer.view.raycastFromPoint(t.getPosition()),m=new Communicator.Point3;o.intersectsRay(h,m);let d=Communicator.Plane.createFromPointAndNormal(e,i),c=Math.abs(Communicator.Util.computeAngleBetweenVector(i,o.normal)),u=new Communicator.Point3;if(c>80&&c<100)u=l(d,m);else{let o=this._viewer.view.raycastFromPoint(t.getPosition());Communicator.Plane.createFromPointAndNormal(e,i).intersectsRay(o,u)}let w=s(this._startPosition,u,i,e);for(let t=0;t<this._startTargetMatrices.length;t++){let e=r(Communicator.Matrix.inverse(this._viewer.model.getNodeNetMatrix(hwv.model.getNodeParent(this._selectedHandleGroup._targetNodes[t]))),i),o=new Communicator.Matrix;Communicator.Util.computeOffaxisRotation(e,w,o);let a=Communicator.Matrix.inverse(this._viewer.model.getNodeNetMatrix(hwv.model.getNodeParent(this._selectedHandleGroup._targetNodes[t]))).transform(this._selectedHandleGroup._targetCenter);this._viewer.model.setNodeMatrix(this._selectedHandleGroup._targetNodes[t],n(a,this._startTargetMatrices[t],o))}this._selectedHandleGroup.updateHandle()}this._manager.refreshAll(this._selectedHandleGroup),t.setHandled(!0)}}async onMouseUp(t){this._selectedHandleGroup&&(this._viewer.model.setNodesFaceColor([this._selectedHandle._nodeid],this.oldColor[0]),this._selectedHandleGroup=null),this._isClick&&this._manager.remove()}}shandle=e})();